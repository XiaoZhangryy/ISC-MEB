---
title: 'iSC.MEB: DLPFC Data Analysis'
author: "Xiao Zhang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{iSC.MEB: DLPFC Data Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy = TRUE,
  fig.width = 11,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  time_it = TRUE
)
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
```
  
This vignette introduces the iSC.MEB workflow for the analysis of two sliced spatial transcriptomics datasets. The workflow consists of three steps

* Independent preprocessing and model setting
* Integrated clustering using iSC.MEB model

We demonstrate the use of iSC.MEB to two human dorsolateral prefrontal cortex Visium data that are [here](https://github.com/XiaoZhangryy/iSC.MEB/tree/main/vignettes_data), which can be downloaded to the current working path by the following command:
```{r eval=TRUE}
githubURL <- "https://github.com/XiaoZhangryy/iSC.MEB/blob/main/vignettes_data/DLPFC_151507_151508.rda?raw=true"
download.file(githubURL,"DLPFC_151507_151508.rda",mode='wb')
```

The package can be loaded with the command:
```{r  eval = TRUE}
library(iSC.MEB)
library(Seurat)
```

Then load datasets to R 
```{r  eval = TRUE}
load("DLPFC_151507_151508.rda")
```

## Fit an iSC.MEB model
First, we view the the spatial transcriptomics data with Visium platform.
```{r  eval = TRUE}
seuList ## a list including two Seurat object
```

### Prepare the iSC.MEB Object.

Create a iSCMEBObj object to prepare for iSC.MEB models.
```{r  eval = TRUE}
preobj <- CreateiSCMEBObject(seuList = seuList, verbose = FALSE)
```
### Add the model setting
```{r  eval = TRUE}
## check the number of genes/features after filtering step
preobj@seulist
## Add adjacency matrix list for a iSCMEBObj object to prepare for iSC.MEB model fitting.
iSCMEBObj <-  CreateNeighbors(preobj, platform = "Visium")
## run PCA to get low dimensional embeddings
iSCMEBObj <-  runPCA(iSCMEBObj, npcs = 15, pca.method = "APCA")
## Add a model setting in advance for an iSCMEBObj object. verbose = TRUE helps outputing the
## information in the algorithm.
iSCMEBObj <- SetModelParameters(iSCMEBObj, verbose = TRUE)
```


### Fit iSC.MEB 
For function `iSCMEB`, users can specify the number of clusters $K$ or set `K` to be an integer vector by using modified MBIC(BIC) to determine $K$. Here, we use user-specified number of clusters. 
```{r  eval = TRUE}
### Given K
iSCMEBObj <- iSCMEB(iSCMEBObj, K= 7)
```

The function `iSCMEB` will automatically choose the optimal path. User can slao using function `SelectModel` to select model.
```{r  eval = TRUE}
## backup the fitting results in resList
resList <- iSCMEBObj@resList
iSCMEBObj <- SelectModel(iSCMEBObj)

LabelList <- lapply(1:2, function(i) iSCMEBObj@seulist[[i]]@meta.data$layer_guess_reordered)
ari_151507 <- mclust::adjustedRandIndex(idents(iSCMEBObj)[[1]], LabelList[[1]])
ari_151508 <- mclust::adjustedRandIndex(idents(iSCMEBObj)[[2]], LabelList[[2]])
ari_all <- mclust::adjustedRandIndex(unlist(idents(iSCMEBObj)), unlist(LabelList))
print(ari_151507)
print(ari_151508)
print(ari_all)
```

## Session information
```{r  eval = TRUE}
sessionInfo()
```