---
title: 'iSC.MEB: DLPFC Data Analysis'
author: "Xiao Zhang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{iSC.MEB: DLPFC Data Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
This vignette introduces the iSC.MEB workflow for the analysis of two sliced spatial transcriptomics datasets. The workflow consists of three steps

* Independent preprocessing and model setting
* Integrated clustering using iSC.MEB model

We demonstrate the use of iSC.MEB to two human dorsolateral prefrontal cortex Visium data that are [here](https://github.com/XiaoZhangryy/iSC.MEB/tree/main/vignettes_data), which can be downloaded to the current working path by the following command:
```{r eval=FALSE}
githubURL <- "https://github.com/feiyoung/iSC.MEB/blob/main/vignettes_data/dlpfc_151672.rda?raw=true"
download.file(githubURL,"dlpfc_151672.rda",mode='wb')

```

Then load to R 
```{r  eval = FALSE}
load("dlpfc_151672.rda")
```


The package can be loaded with the command:
```{r  eval = FALSE}
library(iSC.MEB)
library(Seurat)
```


## Compare iSC.MEB with DR-SC in analyzing one sample
First, we view the the spatial transcriptomics data with Visium platform.
```{r  eval = FALSE}
dlpfc_151672 ## a list including two Seurat object
```

### Prepare the iSC.MEBObject.

Create a iSC.MEBObj object to prepare for iSC.MEB models.
```{r  eval = FALSE}
library(iSC.MEB)
preobj <- CreateiSC.MEBObject(seuList = list(dlpfc_151672))
```
### Add the model setting
```{r  eval = FALSE}
## check the number of genes/features after filtering step
preobj@seulist
## Add adjacency matrix list for a iSC.MEBObj object to prepare for iSC.MEB model fitting.
iSC.MEBObj <-  AddAdjList(preobj, platform = "Visium")
## Add a model setting in advance for a iSC.MEBObj object. verbose =TRUE helps outputing the
## information in the algorithm.
iSC.MEBObj <- AddParSetting(iSC.MEBObj, Sigma_equal = FALSE, coreNum = 1,
                            maxIter=30, verbose = TRUE)

```


### Fit iSC.MEB 
For function `iSC.MEB`, users can specify the number of clusters $K$ or set `K` to be an integer vector by using modified BIC(MBIC) to determine $K$. Here, we use user-specified number of clusters. 
```{r  eval = FALSE}
### Given K
iSC.MEBObj <- iSC.MEB(iSC.MEBObj, K= 7)
```

Select a best model 
```{r  eval = FALSE}
## backup the fitting results in resList
resList <- iSC.MEBObj@resList
iSC.MEBObj <- selectModel(iSC.MEBObj)
ari_iSC.MEB <- mclust::adjustedRandIndex(iSC.MEBObj@resList$cluster[[1]], iSC.MEBObj@seulist[[1]]$layer_guess_reordered)
```

Integrate the reults into a Seurat object seuInt by the function `IntegrateSpaData`.
```{r  eval = FALSE}
seuInt <- IntegrateSpaData(iSC.MEBObj, species='Human')
seuInt 
## The low-dimensional embeddings obtained by iSC.MEB are saved in iSC.MEB reduction slot.
```
Save the spatial and tSNE scatter plots for clusters  from iSC.MEB
```{r  eval = FALSE}
p_sp1 <- SpaPlot(seuInt, item='cluster', point_size = 3, combine = F)[[1]] + cowplot::theme_cowplot() + 
  ggplot2::ggtitle(paste0("iSC.MEB: ARI=", round(ari_iSC.MEB, 2)) ) +
  ggplot2::xlab("row") + ggplot2::ylab("col")
seuInt <- AddTSNE(seuInt,n_comp = 2)
p_tsne <- dimPlot(seuInt, item='cluster')
p_tsne <- p_tsne + cowplot::theme_cowplot() + ggplot2::ggtitle("iSC.MEB")
```



Fit DR-SC and Plot the spatial and tSNE scatter plots for clusters 
```{r  eval = FALSE}
seu_drsc <- DR.SC::DR.SC(iSC.MEBObj@seulist[[1]], K=7, verbose=T)
ari_drsc <- mclust::adjustedRandIndex(seu_drsc$spatial.drsc.cluster, iSC.MEBObj@seulist[[1]]$layer_guess_reordered)
p_tsne_drsc <- DR.SC::drscPlot(seu_drsc)
p_tsne_drsc <- p_tsne_drsc + ggplot2::ggtitle("DR-SC")
p_sp2 <- DR.SC::spatialPlotClusters(seu_drsc)+ cowplot::theme_cowplot()  + 
  ggplot2::ggtitle(paste0("DR-SC ARI=", round(ari_drsc, 2)) ) 
```

Compare the clustering performance of iSC.MEB and DR-SC.

```{r  eval = FALSE}
library(patchwork)
p_sp1 + p_sp2

```


Compare the tSNE visualiztion performance of iSC.MEB and DR-SC.
```{r  eval = FALSE}
p_tsne + p_tsne_drsc
```

## Session information
```{r  eval = FALSE}
sessionInfo()
```