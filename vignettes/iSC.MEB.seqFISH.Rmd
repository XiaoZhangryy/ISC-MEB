---
title: 'iSC.MEB: seqFISH Data Analysis'
author: "Xiao Zhang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{iSC.MEB: seqFISH Data Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy = TRUE,
  fig.width = 11,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  time_it = TRUE
)
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now, units = "secs")
      all_times[[options$label]] <<- res
    }
  }
}))
```
  
This vignette introduces the iSC.MEB workflow for the analysis of seqFISH datasets. The workflow consists of three steps

* Independent preprocessing and model setting
* Integrated clustering using iSC.MEB model

We demonstrate the use of iSC.MEB to 6 mouse embryo tissue sections generated by a modified version of the seqFISH (sequential fluorescence in situ hybridization) method that are [here](https://github.com/XiaoZhangryy/iSC.MEB/tree/main/vignettes_data), which can be downloaded to the current working path by the following command:
```{r eval = TRUE}
githubURL <- "https://github.com/XiaoZhangryy/iSC.MEB/blob/main/vignettes_data/seqFISH.rda?raw=true"
download.file(githubURL,"seqFISH.rda",mode='wb')
```

The package can be loaded with the command:
```{r  eval = TRUE}
library(iSC.MEB)
library(Seurat)
```

Then load datasets to R 
```{r  eval = TRUE}
load("seqFISH.rda")
```


## Fit an iSC.MEB model
First, we view the the spatial transcriptomics data with Visium platform.
```{r  eval = TRUE}
seuList ## a list including six Seurat object
```

### Prepare the iSC.MEB Object.

Create a iSCMEBObj object to prepare for iSC.MEB models.
```{r  eval = TRUE}
Genelist <- row.names(seuList[[1]])
preobj <- CreateiSCMEBObject(seuList = seuList, customGenelist = Genelist, verbose = FALSE)
```
### Add the model setting
```{r  eval = TRUE}
## check the number of genes/features after filtering step
preobj@seulist
## Add adjacency matrix list for a iSCMEBObj object to prepare for iSC.MEB model fitting.
iSCMEBObj <-  CreateNeighbors(preobj, radius.upper=10)
## run PCA to get low dimensional embeddings
iSCMEBObj <-  runPCA(iSCMEBObj, npcs = 15, pca.method = "APCA")
## Add a model setting in advance for an iSCMEBObj object. verbose = TRUE helps outputing the
## information in the algorithm.
iSCMEBObj <- SetModelParameters(iSCMEBObj, verbose = TRUE)
```


### Fit iSC.MEB 
For function `iSCMEB`, users can specify the number of clusters $K$ or set `K` to be an integer vector by using modified MBIC(BIC) to determine $K$. Here, we use user-specified number of clusters. 
```{r  eval = TRUE}
iSCMEBObj <- iSCMEB(iSCMEBObj, K = 18)
```

The function `iSCMEB` will automatically choose the optimal path. User can slao using function `SelectModel` to select model.
```{r  eval = TRUE}
## backup the fitting results in resList
resList <- iSCMEBObj@resList
iSCMEBObj <- SelectModel(iSCMEBObj)

LabelList <- lapply(1:6, function(i) iSCMEBObj@seulist[[i]]@meta.data$celltype_mapped_refined)
ari_sections <- sapply(1:6, function(i) mclust::adjustedRandIndex(idents(iSCMEBObj)[[i]], LabelList[[i]]))
ari_all <- mclust::adjustedRandIndex(unlist(idents(iSCMEBObj)), unlist(LabelList))
print(ari_sections)
print(ari_all)
```

## Session information
```{r  eval = TRUE}
sessionInfo()
```